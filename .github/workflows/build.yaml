name: Build Vial Firmware

on:
  push:
    paths:
      - '**.c'
      - '**.h'
      - '**.mk'
      - '**.json'
      - '.github/workflows/**'
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: qmkfm/qmk_cli:latest

    strategy:
      fail-fast: false
      matrix:
        keyboard: [on_banana_any_day]

    steps:
    - name: Checkout User Repository
      uses: actions/checkout@v4
      with:
        path: my_keyboards

    - name: Checkout Vial-QMK
      uses: actions/checkout@v4
      with:
        repository: vial-kb/vial-qmk
        ref: vial
        submodules: recursive
        path: qmk_firmware

    - name: Copy Keyboard Directory
      run: |
        # 【修正点】コピー元のパスに 'keyboard/' を追加しました
        # ディレクトリが存在するか確認してからコピー
        if [ -d "keyboard/${{ matrix.keyboard }}" ]; then
          cp -r keyboard/${{ matrix.keyboard }} qmk_firmware/keyboards/
        else
          echo "Error: Directory keyboard/${{ matrix.keyboard }} not found!"
          ls -R my_keyboards
          exit 1
        fi

    # デバッグ用：正しく配置されたか確認
    - name: Debug Directory Structure
      run: |
        ls -F qmk_firmware/keyboards/${{ matrix.keyboard }}/ || true

    - name: Build Firmware
      working-directory: qmk_firmware
      run: |
        # ビルド実行
        qmk compile -kb ${{ matrix.keyboard }} -km vial

    - name: Archive Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: vial_firmware_${{ matrix.keyboard }}
        path: |
          qmk_firmware/*.hex
          qmk_firmware/*.uf2
          qmk_firmware/*.bin
